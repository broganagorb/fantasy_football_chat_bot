name: ESPN Discord Bot

on:
  schedule:
    - cron: '30 15 * * 2'   # Tue 10:30 AM CT
    - cron: '00 23 * * 4'   # Thu 6:00 PM CT
    - cron: '30 17 * * 0'   # Sun 12:30 PM CT
    - cron: '30 03 * * 1'   # Mon 10:30 PM CT
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install apscheduler requests espn_api DateTime   

      - name: Test Discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -sS -H "Content-Type: application/json" \
            -d '{"content":"✅ Webhook test from GitHub Actions"}' \
            "$DISCORD_WEBHOOK_URL" -D /tmp/h
          echo "HTTP status:"
          tail -n 1 /tmp/h
          
      - name: Test ESPN connectivity
        env:
          LEAGUE_ID:  ${{ secrets.LEAGUE_ID }}
          LEAGUE_YEAR: ${{ secrets.LEAGUE_YEAR }}
          ESPN_S2:    ${{ secrets.ESPN_S2 }}
          SWID:       ${{ secrets.SWID }}
        run: |
          python - <<'PY'
          import os, sys
          from espn_api.football import League
          try:
              lid  = int(os.environ['LEAGUE_ID'])
              year = int(os.environ['LEAGUE_YEAR'])
              s2   = os.environ.get('ESPN_S2') or None
              swid = os.environ.get('SWID') or None
              lg   = League(league_id=lid, year=year, espn_s2=s2, swid=swid)
              print("✅ ESPN OK:", lg.settings.name)
          except Exception as e:
              print("❌ ESPN ERROR:", e)
              sys.exit(1)
          PY

      - name: Run ESPN bot once
        run: |
          python - <<'PY'
          from gamedaybot.espn import espn_bot
          espn_bot.espn_bot("init")
          PY
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LEAGUE_ID:           ${{ secrets.LEAGUE_ID }}
          LEAGUE_YEAR:         ${{ secrets.LEAGUE_YEAR }}
          TIMEZONE:            ${{ secrets.TIMEZONE }}
          ESPN_S2:             ${{ secrets.ESPN_S2 }}
          SWID:                ${{ secrets.SWID }}
          START_DATE:          ${{ secrets.START_DATE }}
          END_DATE:            ${{ secrets.END_DATE }}
